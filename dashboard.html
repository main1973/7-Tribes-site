<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>7Tribes — Live Community Metrics</title>
  <link rel="icon" href="images/logo.png" />

  <!-- Guard: never let this page hijack the root -->
  <script>
    if (window.location.pathname === "/" || window.location.pathname === "/index.html") {
      window.location.replace("index.html");
    }
  </script>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.min.js"></script>
  <link  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--bg:#0b0b0c;--card:#121214;--text:#eaeaea;--muted:#a1a1a6;--accent:#FFD700;--border:#222}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    header{background:#11141a;border-bottom:1px solid var(--border)}
    .wrap{max-width:1080px;margin:auto;padding:18px}
    h1{margin:0}
    a{color:var(--accent);text-decoration:none}

    /* Cards & layout */
    .cards{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .value{font-size:28px;font-weight:800}
    .bar{height:10px;background:#1a1a1d;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar>i{display:block;height:100%;background:var(--accent);width:0%}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .full{grid-template-columns:1fr}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--border)}
    th{text-align:left;color:var(--muted)}

    /* Map */
    #map{height:320px;border-radius:12px;border:1px solid var(--border);}

    /* Buttons */
    .cta{display:inline-flex;align-items:center;gap:.5rem;background:linear-gradient(90deg,#FFD700,#b8912f);color:#111;
      font-weight:700;border:none;padding:10px 18px;border-radius:30px;cursor:pointer;box-shadow:0 0 12px rgba(255,215,0,.25)}
    .ghost{background:transparent;color:var(--text);border:1px solid #2b2f3b}

    @media (max-width:1100px){.cards{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)} .grid{grid-template-columns:1fr}}
  </style>
</head>

<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="images/logo.png" alt="7TRB" style="width:36px;height:36px;border-radius:50%">
        <h1>Live Community Metrics</h1>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <button id="connectBtn" class="cta">Connect Wallet</button>
        <a href="index.html" class="ghost" style="padding:10px 14px;border-radius:30px;text-decoration:none">← Back</a>
        <p style="color:#FFD700;font-weight:600;margin:6px 0;">
  Treasury Wallet: <b>0x26B0cA2C767758Fc3E34e0481065a55521E42BaB</b>
</p>
     </div>
    </div>
  </header>

  <div class="wrap">
    <p style="color:#a1a1a6;margin:.3rem 0 .7rem">
      Updated <span id="updatedAt">—</span>
      <span id="freshDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#999;margin-left:8px;vertical-align:middle" title="Data age"></span>
    </p>
    <div id="walletBalance" style="margin:-2px 0 10px;color:#FFD700;font-weight:600"></div>

    <!-- KPI CARDS -->
    <section class="cards" aria-label="KPIs">
      <div class="card">
        <div class="label">Holders</div>
        <div class="value" id="holders">—</div>
        <div class="bar"><i id="holdersBar"></i></div>
      </div>
      <div class="card">
        <div class="label">Active wallets (30d)</div>
        <div class="value" id="active">—</div>
        <div class="label">rolling 30 days</div>
      </div>
      <div class="card">
        <div class="label">Treasury (USD)</div>
        <div class="value" id="treasury">—</div>
        <div class="bar"><i id="treasuryBar"></i></div>
      </div>
      <div class="card">
        <div class="label">Spend vs Save (30d)</div>
        <div class="value" id="spendSave">—</div>
        <div class="bar"><i id="spendBar"></i></div>
      </div>
      <div class="card">
        <div class="label">Referrals (30d)</div>
        <div class="value" id="referrals">—</div>
        <div class="label" id="referralsNote">verified sign-ups</div>
      </div>
    </section>

    <!-- CHART + PROJECTS -->
    <div class="grid">
      <section class="card">
        <div class="label" style="margin-bottom:6px">Treasury trend</div>
        <canvas id="treasuryChart" height="140" aria-label="Treasury time series"></canvas>
      </section>

      <section class="card">
        <div class="label" style="margin-bottom:6px">Projects pipeline</div>
        <table>
          <thead><tr><th>Status</th><th>Count</th></tr></thead>
          <tbody id="projRows"></tbody>
        </table>
      </section>
    </div>

    <!-- MERCHANT MAP (auto if lat/lng present) -->
    <div class="grid" style="margin-top:12px">
      <section class="card">
        <div class="label" style="margin-bottom:6px">Merchant map</div>
        <div id="map"></div>
        <div id="mapNotice" class="label" style="margin-top:8px;display:none">Add <code>lat</code> and <code>lng</code> to merchants.json to enable pins.</div>
      </section>

      <section class="card">
        <div class="label" style="margin-bottom:6px">Merchant directory</div>
        <table>
          <thead><tr><th>Name</th><th>City</th><th>Since</th><th>Monthly 7TRB</th></tr></thead>
          <tbody id="merchRows"></tbody>
        </table>
        <p style="margin-top:10px"><a href="merchants.html">View all merchants →</a></p>
      </section>
    </div>
  </div>

  <script>
  // ---- Config for wallet/token ----
  const TOKEN_ADDRESS = "0xD81641716926F6D55dC5AF6929dbE046bBf43c0D"; // 7TRB contract
  const TOKEN_DECIMALS = 18;
  const TOKEN_SYMBOL = "7TRB";
  const TREASURY_WALLET = "0x26B0cA2C767758Fc3E34e0481065a55521E42BaB"; // AmVault Treasury Wallet

  // ---- Helpers ----
  async function safeJson(u){
    try{
      const r = await fetch(u,{cache:'no-store'});
      if(!r.ok) throw new Error(u+': '+r.status);
      return r.json();
    }catch(e){
      console.warn('Fetch failed:', e);
      return null;
    }
  }
  const pct=(v,g)=>{ if(!g) return 0; const d=(g.stretch||g.goal||1);
    return Math.max(0,Math.min(100,Math.round((v/d)*100))); };
  const setBar=(id,p)=>{ const el=document.getElementById(id); if(el) el.style.width=p+'%'; };

  // ---- Load community data ----
  (async function(){
    const [goals, metrics, merchants, referrals] = await Promise.all([
      safeJson('data/goals.json'),
      safeJson('data/metrics.json'),
      safeJson('data/merchants.json'),
      safeJson('data/referrals.json')
    ]);

    if(!metrics){
      document.getElementById('updatedAt').textContent='— (awaiting data/metrics.json)';
      return;
    }

    // Timestamp + freshness
    const upd=new Date(metrics.updated_at); 
    document.getElementById('updatedAt').textContent=upd.toLocaleString();
    const hrs=(Date.now()-upd.getTime())/36e5;
    const dot=document.getElementById('freshDot');
    dot.style.background=hrs<=24?'#22c55e':(hrs<=72?'#f59e0b':'#ef4444'); 
    dot.title=`Data age: ${hrs.toFixed(1)}h`;

    // KPIs
    document.getElementById('holders').textContent=(metrics.holders??0).toLocaleString();
    setBar('holdersBar', pct(metrics.holders??0, goals&&goals.holders));

    document.getElementById('active').textContent=(metrics.active_wallets_30d??0).toLocaleString();

    const tUSD=Math.round(metrics.treasury_usd??0);
    document.getElementById('treasury').textContent='$'+tUSD.toLocaleString();
    setBar('treasuryBar', pct(tUSD, goals&&goals.treasury_usd));

    const spentPct=Math.round(((metrics.spent_pct_30d??0)*100));
    document.getElementById('spendSave').textContent=`${spentPct}% spent / ${100-spentPct}% saved`;
    setBar('spendBar', Math.max(0,Math.min(100,spentPct)));

    document.getElementById('referrals').textContent = referrals && referrals.total !== undefined
      ? referrals.total.toLocaleString() : '0';

    // Projects table
    const pr=metrics.projects||{}; const body=document.getElementById('projRows');
    [['Proposed',pr.proposed],['Approved',pr.approved],['Funded',pr.funded],['Delivered',pr.delivered]]
      .forEach(([k,v])=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${k}</td><td>${v??0}</td>`;
        body.appendChild(tr);
      });

    // Merchants table
    if(Array.isArray(merchants)){
      const m=document.getElementById('merchRows');
      merchants.forEach(x=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${x.url?`<a href="${x.url}" target="_blank" rel="noopener">${x.name}</a>`:x.name}</td>
          <td>${x.city||''}</td>
          <td>${x.since||''}</td>
          <td>${x.monthly_volume??0}</td>`;
        m.appendChild(tr);
      });
    }

    // Chart
    const series=metrics.treasury_series||[];
    const labels=series.map(x=>x[0]); const data=series.map(x=>x[1]);
    const ctx=document.getElementById('treasuryChart');
    if(ctx && labels.length){
      new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Treasury (USD)',data,tension:.25,borderColor:'#FFD700'}]},
        options:{plugins:{legend:{display:false}},scales:{x:{grid:{color:'#222'}},y:{grid:{color:'#222'}}}}});
    }

    // Map (only if lat/lng exist)
    try{
      const hasGeo = Array.isArray(merchants) && merchants.some(m => typeof m.lat==='number' && typeof m.lng==='number');
      const mapNotice = document.getElementById('mapNotice');
      if(!hasGeo){ mapNotice.style.display='block'; return; }

      const map=L.map('map',{zoomControl:true,scrollWheelZoom:false});
      const points=merchants.filter(m=>typeof m.lat==='number'&&typeof m.lng==='number');
      const latlngs=points.map(m=>[m.lat,m.lng]);
      const center=[(latlngs.reduce((s,p)=>s+p[0],0)/latlngs.length)||42.3314,(latlngs.reduce((s,p)=>s+p[1],0)/latlngs.length)||-83.0458];
      map.setView(center, 3);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
      points.forEach(m=>{
        L.marker([m.lat,m.lng]).addTo(map)
         .bindPopup(`<b>${m.name||'Merchant'}</b><br>${m.city||''}${m.url?`<br><a href="${m.url}" target="_blank" rel="noopener">Website</a>`:''}`);
      });
      if(latlngs.length>1) L.featureGroup(latlngs.map(ll=>L.marker(ll))).addTo(map) && map.fitBounds(latlngs, {padding:[20,20]});
    }catch(e){ console.warn('Map init failed:', e); }
  })();

  <script>
/* -------------------------------
   7TRB DASHBOARD WALLET HANDLER
   Works in MetaMask + Mobile
-------------------------------- */

const TOKEN_ADDRESS = "0xD81641716926F6D55dC5AF6929dbE046bBf43c0D";  // Ethereum 7TRB
const TOKEN_DECIMALS = 18;
const TOKEN_SYMBOL = "7TRB";

/** Make connect button pretty */
function updateButton(account) {
  const btn = document.getElementById("connectBtn");
  if (!btn) return;

  if (account) {
    btn.textContent = account.slice(0, 6) + "..." + account.slice(-4);
    btn.style.background = "linear-gradient(90deg,#FFD700,#b8912f)";
  } else {
    btn.textContent = "Connect Wallet";
    btn.style.background = "";
  }
}

/** Fetch 7TRB balance USING THE USER'S WALLET PROVIDER */
async function showBalance(account) {
  if (!account) return;

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const contract = new ethers.Contract(
      TOKEN_ADDRESS,
      ["function balanceOf(address) view returns (uint256)"],
      provider
    );

    const raw = await contract.balanceOf(account);
    const balance = Number(raw) / 10 ** TOKEN_DECIMALS;

    document.getElementById("walletBalance").textContent =
      `Your Balance: ${balance.toFixed(3)} ${TOKEN_SYMBOL}`;
  } catch (err) {
    console.error("Balance error:", err);
  }
}

/** Connect wallet */
async function connectWallet() {
  if (!window.ethereum) {
    alert("No wallet found. Use MetaMask or a Web3 browser.");
    return;
  }

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    const account = accounts[0];

    updateButton(account);
    showBalance(account);

  } catch (err) {
    console.error("Connect error:", err);
    alert("Wallet connection failed.");
  }
}

/** Auto-connect if already authorized */
async function checkConnection() {
  if (!window.ethereum) return;

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_accounts", []);

    if (accounts.length > 0) {
      updateButton(accounts[0]);
      showBalance(accounts[0]);
    }
  } catch (err) {
    console.error("Auto-connect error:", err);
  }
}

/** Listen for account changes */
if (window.ethereum) {
  ethereum.on("accountsChanged", (accounts) => {
    if (accounts.length === 0) {
      updateButton(null);
      document.getElementById("walletBalance").textContent = "";
    } else {
      updateButton(accounts[0]);
      showBalance(accounts[0]);
    }
  });
}
<script>
/* -------------------------------
   7TRB DASHBOARD WALLET HANDLER
   Works in MetaMask + Mobile
-------------------------------- */

const TOKEN_ADDRESS = "0xD81641716926F6D55dC5AF6929dbE046bBf43c0D";  // Ethereum 7TRB
const TOKEN_DECIMALS = 18;
const TOKEN_SYMBOL = "7TRB";

/** Make connect button pretty */
function updateButton(account) {
  const btn = document.getElementById("connectBtn");
  if (!btn) return;

  if (account) {
    btn.textContent = account.slice(0, 6) + "..." + account.slice(-4);
    btn.style.background = "linear-gradient(90deg,#FFD700,#b8912f)";
  } else {
    btn.textContent = "Connect Wallet";
    btn.style.background = "";
  }
}

/** Fetch 7TRB balance USING THE USER'S WALLET PROVIDER */
async function showBalance(account) {
  if (!account) return;

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const contract = new ethers.Contract(
      TOKEN_ADDRESS,
      ["function balanceOf(address) view returns (uint256)"],
      provider
    );

    const raw = await contract.balanceOf(account);
    const balance = Number(raw) / 10 ** TOKEN_DECIMALS;

    document.getElementById("walletBalance").textContent =
      `Your Balance: ${balance.toFixed(3)} ${TOKEN_SYMBOL}`;
  } catch (err) {
    console.error("Balance error:", err);
  }
}

/** Connect wallet */
async function connectWallet() {
  if (!window.ethereum) {
    alert("No wallet found. Use MetaMask or a Web3 browser.");
    return;
  }

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_requestAccounts", []);
    const account = accounts[0];

    updateButton(account);
    showBalance(account);

  } catch (err) {
    console.error("Connect error:", err);
    alert("Wallet connection failed.");
  }
}

/** Auto-connect if already authorized */
async function checkConnection() {
  if (!window.ethereum) return;

  try {
    const provider = new ethers.BrowserProvider(window.ethereum);
    const accounts = await provider.send("eth_accounts", []);

    if (accounts.length > 0) {
      updateButton(accounts[0]);
      showBalance(accounts[0]);
    }
  } catch (err) {
    console.error("Auto-connect error:", err);
  }
}

/** Listen for account changes */
if (window.ethereum) {
  ethereum.on("accountsChanged", (accounts) => {
    if (accounts.length === 0) {
      updateButton(null);
      document.getElementById("walletBalance").textContent = "";
    } else {
      updateButton(accounts[0]);
      showBalance(accounts[0]);
    }
  });
}

/** Init */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("connectBtn").addEventListener("click", connectWallet);
  checkConnection();
});
</script>
