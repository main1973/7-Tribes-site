<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>7Tribes — Live Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#0b0b0c;--card:#121214;--text:#eaeaea;--muted:#a1a1a6;--accent:#FFD700;--border:#222}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    .wrap{max-width:1080px;margin:auto;padding:20px}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
    .value{font-size:28px;font-weight:800}
    .bar{height:10px;background:#1a1a1d;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar>i{display:block;height:100%;background:var(--accent);width:0%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid var(--border)}
    th{text-align:left;color:var(--muted)}
    a{color:var(--accent);text-decoration:none}
    @media (max-width:900px){.cards{grid-template-columns:repeat(2,1fr)} .grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
      <h1 style="margin:0">7Tribes — Live Transparency</h1>
      <a href="index.html">← Back</a>
    </div>
    <p style="color:#a1a1a6;margin:.3rem 0 1rem">
      Updated <span id="updatedAt">—</span>
      <span id="freshDot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#999;margin-left:8px;vertical-align:middle" title="Data age"></span>
    </p>

    <section class="cards" aria-label="KPIs">
      <div class="card"><div class="label">Holders</div><div class="value" id="holders">—</div><div class="bar"><i id="holdersBar"></i></div></div>
      <div class="card"><div class="label">Active wallets (30d)</div><div class="value" id="active">—</div><div class="label" id="activeNote">rolling 30 days</div></div>
      <div class="card"><div class="label">Treasury (USD)</div><div class="value" id="treasury">—</div><div class="bar"><i id="treasuryBar"></i></div></div>
      <div class="card"><div class="label">Spend vs Save (30d)</div><div class="value" id="spendSave">—</div><div class="bar"><i id="spendBar"></i></div></div>
    </section>

    <div class="grid">
      <section class="card">
        <div class="label" style="margin-bottom:6px">Treasury trend</div>
        <canvas id="treasuryChart" height="140" aria-label="Treasury time series"></canvas>
      </section>

      <section class="card">
        <div class="label" style="margin-bottom:6px">Projects pipeline</div>
        <table><thead><tr><th>Status</th><th>Count</th></tr></thead><tbody id="projRows"></tbody></table>
      </section>
    </div>

    <section class="card" style="margin-top:12px">
      <div class="label" style="margin-bottom:6px">Merchant directory</div>
      <table><thead><tr><th>Name</th><th>City</th><th>Since</th><th>Monthly 7TRB</th></tr></thead><tbody id="merchRows"></tbody></table>
      <p style="margin-top:10px"><a href="merchants.html">View all merchants →</a></p>
    </section>
  </div>

  <script>
  (async function(){
    async function safeJson(u){try{const r=await fetch(u,{cache:'no-store'});if(!r.ok)throw new Error(u+': '+r.status);return r.json()}catch(e){console.warn('Fetch failed:',e);return null}}

    const [goals, metrics, merchants] = await Promise.all([
      safeJson('data/goals.json'),
      safeJson('data/metrics.json'),
      safeJson('data/merchants.json')
    ]);

    if(!metrics){document.getElementById('updatedAt').textContent='— (awaiting data/metrics.json)';return}

    const upd=new Date(metrics.updated_at); document.getElementById('updatedAt').textContent=upd.toLocaleString();
    const hrs=(Date.now()-upd.getTime())/36e5; const dot=document.getElementById('freshDot');
    dot.style.background=hrs<=24?'#22c55e':(hrs<=72?'#f59e0b':'#ef4444'); dot.title=`Data age: ${hrs.toFixed(1)}h`;

    const pct=(v,g)=>{if(!g)return 0;const d=(g.stretch||g.goal||1);return Math.max(0,Math.min(100,Math.round((v/d)*100)))};
    const setBar=(id,p)=>{const el=document.getElementById(id); if(el) el.style.width=p+'%'};

    document.getElementById('holders').textContent=(metrics.holders??0).toLocaleString();
    setBar('holdersBar', pct(metrics.holders??0, goals&&goals.holders));

    document.getElementById('active').textContent=(metrics.active_wallets_30d??0).toLocaleString();

    const tUSD=Math.round(metrics.treasury_usd??0);
    document.getElementById('treasury').textContent='$'+tUSD.toLocaleString();
    setBar('treasuryBar', pct(tUSD, goals&&goals.treasury_usd));

    const spentPct=Math.round(((metrics.spent_pct_30d??0)*100));
    document.getElementById('spendSave').textContent=`${spentPct}% spent / ${100-spentPct}% saved`;
    setBar('spendBar', Math.max(0,Math.min(100,spentPct)));

    const pr=metrics.projects||{}; const body=document.getElementById('projRows');
    [['Proposed',pr.proposed],['Approved',pr.approved],['Funded',pr.funded],['Delivered',pr.delivered]].forEach(([k,v])=>{
      const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td>${v??0}</td>`; body.appendChild(tr);
    });

    if(Array.isArray(merchants)){const m=document.getElementById('merchRows'); merchants.forEach(x=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.url?`<a href="${x.url}" target="_blank" rel="noopener">${x.name}</a>`:x.name}</td><td>${x.city||''}</td><td>${x.since||''}</td><td>${x.monthly_volume??0}</td>`;
      m.appendChild(tr);
    });}

    const series=metrics.treasury_series||[]; const labels=series.map(x=>x[0]); const data=series.map(x=>x[1]);
    const ctx=document.getElementById('treasuryChart'); if(ctx && labels.length){
      new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Treasury (USD)',data,borderColor:'#FFD700',tension:.25}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{color:'#222'}},y:{grid:{color:'#222'}}}}});
    }
  })();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .catch(err => console.warn('SW register failed:', err));
  }
</script>

</body>
</html>
